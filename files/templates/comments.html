{%- include 'component/comment/usernotes_header.html' -%}

{# "level" represents the nested level in this call; always starts at 1 #}
{# this is distinct from "comment.level", which is the global depth of this comment #}
{%- macro single_comment(c, level) -%}
{% if should_hide_score or c.should_hide_score %}
	{% set ups="" %}
	{% set downs="" %}
	{% set score="" %}
{% else %}
	{% set ups=c.upvotes %}
	{% set downs=c.downvotes %}
	{% set score=c.score %}
{% endif %}
{% if v and (v.shadowbanned or v.admin_level > 1) %}
	{% set replies=c.replies_ignoring_shadowbans %}
{% else %}
	{% set replies=c.replies(v) %}
{% endif %}
{%- if (c.is_banned or c.deleted_utc or c.is_blocking) and not (v and v.admin_level > 1) and not (v and v.id==c.author_id) -%}
<div id="comment-{{c.id}}" class="comment">
		<div class="comment-collapse-icon" onclick="collapse_comment('{{c.id}}', this.parentElement)"></div>
		<div class="comment-collapse-bar-click" onclick="collapse_comment('{{c.id}}', this.parentElement)">
			<div class="comment-collapse-bar"></div>
		</div>
		<div class="comment-user-info">
			{% if standalone and c.over_18 %}<span class="badge badge-danger">+18</span>{% endif %}
			{% if c.is_banned %}removed by @{{c.ban_reason}}{% elif c.deleted_utc %}Deleted by author{% elif c.is_blocking %}You are blocking @{{c.author_name}}{% endif %}
		</div>
		<div class="comment-body">
				<div id="comment-{{c.id}}-only" class="comment-{{c.id}}-only"></div>
	{% if render_replies %} 
		{% if level <= RENDER_DEPTH_LIMIT - 1 %}
			<div id="replies-of-{{c.id}}" class="">
				{% set standalone=False %}
				{% for reply in replies %}
					{{single_comment(reply, level=level+1)}}
				{% endfor %}
			</div>
		{% elif replies and "notifications" in request.path %}
			<div id="replies-of-{{c.id}}" class="d-none d-md-block">
				{% set standalone=False %}
				{% for reply in replies %}
					{{single_comment(reply, level=level+1)}}
				{% endfor %}
			</div>
			<div id="morecomment-{{c.id}}" class="d-md-none mt-2 more-comments">
				<a href="{{c.morecomments}}">More comments <i class="fas fa-long-arrow-right ml-1"></i></a>
			</div>
		{% elif replies %}
			<div id="morecomment-{{c.id}}" class="mt-2 more-comments">
				<button id="btn-{{c.id}}" class="d-none d-md-block btn btn-primary" onclick="morecomments('{{c.id}}')">More comments ({{c.descendant_count}})</button>
				<a class="d-md-none" href="{{c.morecomments}}">More comments <i class="fas fa-long-arrow-right ml-1"></i></a>
			</div>
		{% endif %}
	{% endif %}
</div>
</div>
{% else %}

{% if v %}
	{% set voted=c.voted %}
	{% if not voted and v.id == c.author_id %}
		{% set voted=1 %}
	{% endif %}
{% else %}
	{% set voted=-2 %}
{% endif %}

{%- if standalone and level==1 -%}
<div class="post-info post-row-cid-{{c.id}} mb-1 mr-2 {% if request.path == '/notifications' %}mt-5{% else %}mt-3{% endif %}">
	{% if c.post and c.post.over_18 %}<span class="badge badge-danger text-small-extra mr-1">+18</span>{% endif %}
	<span class="align-top">
		<span class="font-weight-bold">{{c.header_msg(v, is_notification_page, replies | length) | safe}}</span>
		{% if c.post and c.post.sub %}
			<span class="ml-1"> in <a href="/h/{{c.post.sub}}" {% if v and v.newtab and not g.webview %}target="_blank"{% endif %}>/h/{{c.post.sub}}</a></span>
		{% endif %}
	</span>
</div>
{%- endif -%}

{% set isreply = not standalone and c.parent_comment and c.parent_comment.sentto %}

<div id="comment-{{c.id}}" class="anchor comment {% if standalone and level==1 %} mt-0{% endif %} {% if c.collapse_for_user(v,request.path) %}collapsed{% endif %}">
	{% if not isreply %}
		<div class="comment-collapse-icon" onclick="collapse_comment('{{c.id}}', this.parentElement)"></div>
		<div class="comment-collapse-bar-click" onclick="collapse_comment('{{c.id}}', this.parentElement)">
			<div class="comment-collapse-bar collapse-bar-{{(c.level + RENDER_DEPTH_LIMIT - 2) % RENDER_DEPTH_LIMIT + 1}}"></div>
		</div>
	{% endif %}
	{%- include 'component/comment/user_info.html' -%}
	<div class="comment-body">
		<div id="{% if comment_info and comment_info.id == c.id %}context{% else %}comment-{{c.id}}-only{% endif %}" class="{% if c.unread %}unread{% endif %} comment-{{c.id}}-only comment-anchor {% if comment_info and comment_info.id == c.id %}context{%endif%}{% if c.is_banned %} banned{% endif %}{% if c.deleted_utc %} deleted{% endif %}">
			{%- include 'component/comment/flag_moderation.html' -%}
			{% if c.is_banned and c.ban_reason %}
				<div id="comment-banned-warning" class="comment-text text-removed mb-0">removed by @{{c.ban_reason}}</div>
			{% endif %}

			<div id="comment-text-{{c.id}}" class="comment-text mb-0">
				{{c.realbody(v) | safe}}
			</div>
			{% if c.parent_submission %}
				{% if v and v.id == c.author_id %}
					{%- include 'component/comment/editor.html' -%}
				{% endif %}
				{%- include 'component/comment/actions.html' -%}
			{% endif %}
		</div>
		{% if v and v.id != c.author_id and c.body %}
			<textarea autocomplete="off" class="d-none card border my-2 p-3 comment-box form-control rounded" id="markdown-{{c.id}}" readonly>{{c.body.strip()}}</textarea> 
		{% endif %}
		{%- include 'component/comment/comment_reply.html' -%}
	<div id="replies-of-{{c.id}}">
		{%- if render_replies -%}
			{% if level <= RENDER_DEPTH_LIMIT - 1 or request.path == '/notifications' %}
				<div id="replies-of-{{c.id}}">
					{% for reply in replies %}
						{{single_comment(reply, level=level + 1)}}
					{% endfor %}
				</div>
			{% elif replies %}
				<div id="morecomments-{{c.id}}" class="mt-2 more-comments">
					<button id="btn-{{c.id}}" class="d-none d-md-block btn btn-primary" onclick="morecomments('{{c.id}}')">More comments ({{c.descendant_count}})</button>
					<a class="d-md-none" href="{{c.morecomments}}">More comments <i class="fas fa-long-arrow-right ml-1"></i></a>
				</div>
			{% endif %}
			{%- include 'component/comment/message_reply.html' -%}
		{%- endif -%}
	</div>
	</div>
	{%- include 'component/comment/actions_mobile.html' -%}
</div>
{% endif %}
{%- endmacro -%}

{%- for comment in comments -%}
	{% set parent_level = parent_level | int if parent_level else 0 %}
	{{ single_comment(comment, level = parent_level + 1) }}
{%- endfor -%}
{% if offset %}
	{% if p %}
		{% set pid = p.id %}
	{% endif %}
	<div id="viewmore-{{offset}}">
		<br>
		<button id="viewbtn" class="btn btn-primary" onclick="viewmore({{pid}},'{{sort}}',{{offset}},{{ids}})">VIEW MORE COMMENTS</button>
	</div>
{% endif %}
{% if not ajax %}
	{% if v %}
		{% if v.admin_level > 1 %}
			{% include "component/modal/ban.html" %}
		{% endif %}
	{%- include 'component/modal/comment/delete.html' -%}
	{%- include 'component/modal/comment/report.html' -%}
	{% endif %}

	{% if v %}
		<script src="{{ 'js/vendor/purify.min.js' | asset }}"></script>
		<script src="{{ 'js/vendor/marked.min.js' | asset }}"></script>
		<script src="{{ 'js/marked.custom.js' | asset }}"></script>
		<script src="{{ 'js/comments_v.js' | asset }}"></script>
		{% if FEATURES['AWARDS'] %}
			<script src="{{ 'js/award_modal.js' | asset }}"></script>
		{% endif %}
	{% endif %}

	<script src="{{ 'js/clipboard.js' | asset }}"></script>

	{% if v and v.admin_level > 1 %}
		<script src="{{ 'js/comments_admin.js' | asset }}"></script>
		<script src="{{ 'js/filter_actions.js' | asset }}"></script>
	{% endif %}

	{% include 'component/modal/expanded_image.html' %}

	<script src="{{ 'js/comments+submission_listing.js' | asset }}"></script>
	<script src="{{ 'js/comments.js' | asset }}"></script>

	{%- include 'component/comment/highlight_and_more_comments.html' -%}
{% endif %}
